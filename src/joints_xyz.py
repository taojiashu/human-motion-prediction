import numpy as np
import h5py
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.animation as animation
from mpl_toolkits.mplot3d import Axes3D
import viz
import time
import copy
import data_utils


def fkl( angles, parent, offset, expmapInd, posIdn ):
  """
  Convert joint angles and bone lenghts into the 3d points of a person.
  Based on expmap2xyz.m, available at
  https://github.com/asheshjain399/RNNexp/blob/7fc5a53292dc0f232867beb66c3a9ef845d705cb/structural_rnn/CRFProblems/H3.6m/mhmublv/Motion/exp2xyz.m

  Args
    angles: 99-long vector with 3d position and 3d joint angles in expmap format
    parent: 32-long vector with parent-child relationships in the kinematic tree
    offset: 96-long vector with bone lenghts
    rotInd: 32-long list with indices into angles
    expmapInd: 32-long list with indices into expmap angles
  Returns
    xyz: 32x3 3d points that represent a person in 3d space
  """

  assert len(angles) == 99

  # Structure that indicates parents for each joint
  njoints   = 32
  xyzStruct = [dict() for x in range(njoints)]

  for i in np.arange( njoints ):

    r = angles[ expmapInd[i] ]

    thisRotation = data_utils.expmap2rotmat(r)
    thisPosition = angles[posIdn]

    if parent[i] == -1: # Root node
      xyzStruct[i]['rotation'] = thisRotation
      xyzStruct[i]['xyz']      = np.reshape(offset[i,:], (1,3)) + thisPosition
    else:
      xyzStruct[i]['xyz'] = (offset[i,:] + thisPosition).dot( xyzStruct[ parent[i] ]['rotation'] ) + xyzStruct[ parent[i] ]['xyz']
      xyzStruct[i]['rotation'] = thisRotation.dot( xyzStruct[ parent[i] ]['rotation'] )

  xyz = [xyzStruct[i]['xyz'] for i in range(njoints)]
  xyz = np.array( xyz ).squeeze()
  #xyz = xyz[:,[0,2,1]]
  # xyz = xyz[:,[2,0,1]]


  return np.reshape( xyz, (-1,3) )


parent = np.array([0, 1, 2, 3, 4, 5, 1, 7, 8, 9,10, 1,12,13,14,15,13,
                    17,18,19,20,21,20,23,13,25,26,27,28,29,28,31])-1

offset = np.array([0.000000,0.000000,0.000000,-132.948591,0.000000,0.000000,0.000000,-442.894612,0.000000,0.000000,-454.206447,0.000000,0.000000,0.000000,162.767078,0.000000,0.000000,74.999437,132.948826,0.000000,0.000000,0.000000,-442.894413,0.000000,0.000000,-454.206590,0.000000,0.000000,0.000000,162.767426,0.000000,0.000000,74.999948,0.000000,0.100000,0.000000,0.000000,233.383263,0.000000,0.000000,257.077681,0.000000,0.000000,121.134938,0.000000,0.000000,115.002227,0.000000,0.000000,257.077681,0.000000,0.000000,151.034226,0.000000,0.000000,278.882773,0.000000,0.000000,251.733451,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,99.999627,0.000000,100.000188,0.000000,0.000000,0.000000,0.000000,0.000000,257.077681,0.000000,0.000000,151.031437,0.000000,0.000000,278.892924,0.000000,0.000000,251.728680,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,99.999888,0.000000,137.499922,0.000000,0.000000,0.000000,0.000000])
offset = offset.reshape(-1,3)
expmapInd = np.split(np.arange(4, 100) - 1, 32)
posIdn = np.arange(0,3)

angles = np.array([0.0000000,0.0000000,0.0000000,0.0000001,-0.0000001,-0.0000001,0.1260304,-0.5237637,-0.0963259,-0.0771739,-0.0000000,-0.0000000,-0.0564620,0.4403059,-0.1081036,0.2879221,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2292446,0.3532525,-0.0048348,-0.2951579,-0.0000000,-0.0000000,0.1386397,-0.3537890,0.0231425,0.2137599,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4341051,0.0297915,-0.1274830,-0.1913505,0.0167854,0.0951417,-0.7717000,0.0908271,-0.2600859,1.1202877,0.0721430,0.2745904,-0.0000000,-0.0000000,-0.0000000,-0.2377433,-0.0258345,2.0595834,-0.5111030,-0.0223331,0.6265701,-0.6947283,-0.0000000,-0.0000000,0.0958971,-0.3712137,-0.4534200,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0458259,0.0469026,-2.1039228,-0.2851474,0.0955554,-0.7301263,-0.4028516,-0.0000000,-0.0000000,0.0109158,0.0675502,0.0978250,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
1.4642180,-0.1608990,0.2993056,0.0043904,-0.0101275,0.0046981,0.1222906,-0.5134301,-0.1004342,-0.0791884,-0.0000000,-0.0000000,-0.0553236,0.4401827,-0.1084846,0.2897175,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2434135,0.3337959,-0.0031337,-0.3341625,-0.0000000,-0.0000000,0.1466909,-0.4059486,0.0226090,0.2086175,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4367596,0.0372072,-0.1266949,-0.2071369,0.0194617,0.0841405,-0.7539248,0.1019197,-0.2547856,1.1156999,0.0739205,0.2767424,-0.0000000,-0.0000000,-0.0000000,-0.2324926,-0.0202079,2.0587552,-0.5070288,-0.0316754,0.6345178,-0.6958069,-0.0000000,-0.0000000,0.1004112,-0.3691529,-0.4214407,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0352885,0.0412210,-2.0943563,-0.2743050,0.0992934,-0.7364140,-0.3862431,-0.0000000,-0.0000000,0.0239768,0.1046731,0.0905932,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
1.4546112,-0.7328619,-0.7713283,0.0030791,-0.0033280,0.0048362,0.1229829,-0.5119109,-0.1041269,-0.0836357,-0.0000000,-0.0000000,-0.0526491,0.4391385,-0.1134495,0.2920890,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2589462,0.3031573,-0.0049971,-0.3753383,-0.0000000,-0.0000000,0.1527312,-0.4351909,0.0170801,0.2061387,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4217741,0.0360743,-0.1334480,-0.1919064,0.0262500,0.0859230,-0.7559522,0.1060558,-0.2564336,1.1219765,0.0733622,0.2810119,-0.0000000,-0.0000000,-0.0000000,-0.2312928,-0.0300223,2.0571692,-0.5016171,-0.0459190,0.6353289,-0.6879913,-0.0000000,-0.0000000,0.1023133,-0.3590158,-0.3840609,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0398924,0.0467039,-2.0966470,-0.2600371,0.0948853,-0.7373430,-0.3691756,-0.0000000,-0.0000000,0.0364889,0.1047986,0.0828730,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
1.7075067,-0.6464121,-0.3251959,0.0036763,-0.0061227,0.0046372,0.1198083,-0.5068415,-0.1069328,-0.0833709,-0.0000000,-0.0000000,-0.0503061,0.4374062,-0.1180775,0.2929380,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2719881,0.2900144,-0.0092189,-0.4157566,-0.0000000,-0.0000000,0.1544785,-0.4393618,0.0006134,0.2049111,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4167764,0.0390045,-0.1350160,-0.1957382,0.0293161,0.0795649,-0.7466279,0.1109144,-0.2551636,1.1260184,0.0728169,0.2820587,-0.0000000,-0.0000000,-0.0000000,-0.2311976,-0.0300798,2.0573437,-0.4974201,-0.0626937,0.6354629,-0.6730932,-0.0000000,-0.0000000,0.1042494,-0.3494259,-0.3392626,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0365357,0.0472545,-2.0953276,-0.2481337,0.0925863,-0.7381355,-0.3443552,-0.0000000,-0.0000000,0.0374825,0.1008948,0.0835662,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
2.1680596,-0.3204521,0.2116788,0.0027140,-0.0081724,0.0053100,0.1164297,-0.5085765,-0.1095794,-0.0818392,-0.0000000,-0.0000000,-0.0480717,0.4448492,-0.1223494,0.2919739,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2833556,0.2939115,-0.0152269,-0.4538729,-0.0000000,-0.0000000,0.1568434,-0.4291883,-0.0015784,0.2047716,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4158161,0.0426247,-0.1373183,-0.2031494,0.0326336,0.0742024,-0.7381942,0.1144913,-0.2550749,1.1327662,0.0720911,0.2815416,-0.0000000,-0.0000000,-0.0000000,-0.2293183,-0.0278790,2.0599284,-0.4923238,-0.0877723,0.6326669,-0.6533553,-0.0000000,-0.0000000,0.1149554,-0.3727086,-0.2978109,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0339248,0.0467226,-2.0980735,-0.2295704,0.0874632,-0.7342674,-0.3253869,-0.0000000,-0.0000000,0.0442615,0.0931944,0.0803903,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
2.0980418,-0.2665417,0.5649030,0.0006394,-0.0057648,0.0034270,0.1125064,-0.5030637,-0.1103567,-0.0769718,-0.0000000,-0.0000000,-0.0473857,0.4454898,-0.1230484,0.2914045,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2908890,0.3085501,-0.0214431,-0.4823235,-0.0000000,-0.0000000,0.1516999,-0.4163079,0.0053283,0.2069432,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4179071,0.0455423,-0.1373246,-0.2121242,0.0333545,0.0686048,-0.7287294,0.1162598,-0.2554065,1.1370956,0.0699953,0.2785875,-0.0000000,-0.0000000,-0.0000000,-0.2299934,-0.0269628,2.0628836,-0.4865564,-0.1140227,0.6287724,-0.6301005,-0.0000000,-0.0000000,0.1254267,-0.3886360,-0.2537485,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0313575,0.0478113,-2.1016493,-0.2114697,0.0830409,-0.7297281,-0.3057904,-0.0000000,-0.0000000,0.0488538,0.0903606,0.0785300,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
2.0557323,0.0046032,1.3948022,-0.0001817,-0.0023395,0.0029878,0.1091321,-0.5024989,-0.1111714,-0.0729782,-0.0000000,-0.0000000,-0.0484344,0.4499935,-0.1186939,0.2929626,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2903886,0.3288027,-0.0291674,-0.4957782,-0.0000000,-0.0000000,0.1454162,-0.3935617,0.0516482,0.2128260,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4230050,0.0483383,-0.1362627,-0.2225059,0.0324451,0.0613292,-0.7183477,0.1205335,-0.2560005,1.1387756,0.0664945,0.2769928,-0.0000000,-0.0000000,-0.0000000,-0.2294807,-0.0261720,2.0660853,-0.4759224,-0.1368950,0.6309151,-0.6008593,-0.0000000,-0.0000000,0.1319570,-0.4093927,-0.2167785,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0300538,0.0511875,-2.1037076,-0.1966994,0.0803557,-0.7265691,-0.2823541,-0.0000000,-0.0000000,0.0531095,0.0837350,0.0780790,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
2.0826764,0.0797910,1.8350554,-0.0023582,-0.0001294,0.0025865,0.1084241,-0.5044942,-0.1112885,-0.0707714,-0.0000000,-0.0000000,-0.0465738,0.4524226,-0.1193181,0.2910387,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2825983,0.3444183,-0.0391873,-0.4874600,-0.0000000,-0.0000000,0.1543754,-0.3507361,0.1105979,0.2129227,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4296260,0.0513341,-0.1338155,-0.2308491,0.0304646,0.0524538,-0.7111023,0.1199006,-0.2562135,1.1417927,0.0636213,0.2744777,-0.0000000,-0.0000000,-0.0000000,-0.2272354,-0.0277255,2.0699761,-0.4630713,-0.1595442,0.6362662,-0.5670453,-0.0000000,-0.0000000,0.1366305,-0.4252882,-0.1860131,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0280478,0.0550586,-2.1036453,-0.1809434,0.0798424,-0.7256922,-0.2597940,-0.0000000,-0.0000000,0.0602212,0.0797013,0.0763045,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
2.3935609,0.2589226,2.0395603,-0.0037574,0.0031977,0.0021110,0.1094327,-0.5073444,-0.1107792,-0.0698196,-0.0000000,-0.0000000,-0.0450333,0.4538381,-0.1183793,0.2879048,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2692522,0.3462232,-0.0484898,-0.4616204,-0.0000000,-0.0000000,0.1567592,-0.3187079,0.1124869,0.2161637,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4344094,0.0521269,-0.1335434,-0.2323743,0.0291508,0.0475067,-0.7080293,0.1197108,-0.2589186,1.1446726,0.0578476,0.2739287,-0.0000000,-0.0000000,-0.0000000,-0.2263374,-0.0327426,2.0743642,-0.4450030,-0.1813213,0.6428697,-0.5293269,-0.0000000,-0.0000000,0.1418551,-0.4332394,-0.1688204,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0253730,0.0606405,-2.1045461,-0.1650445,0.0830896,-0.7258626,-0.2387802,-0.0000000,-0.0000000,0.0597255,0.0462506,0.0808471,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
2.7232826,0.3706657,1.8761345,-0.0034277,0.0040627,0.0008976,0.1115321,-0.5130867,-0.1092992,-0.0715950,-0.0000000,-0.0000000,-0.0433230,0.4582353,-0.1160682,0.2882415,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.2525178,0.3440633,-0.0532545,-0.4290316,-0.0000000,-0.0000000,0.1600244,-0.3072546,0.1095724,0.2107728,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,0.4368083,0.0523031,-0.1335256,-0.2300573,0.0285789,0.0454709,-0.7066324,0.1205489,-0.2633802,1.1458323,0.0504215,0.2733918,-0.0000000,-0.0000000,-0.0000000,-0.2252225,-0.0396677,2.0790002,-0.4237086,-0.2011222,0.6507009,-0.4872017,-0.0000000,-0.0000000,0.1440685,-0.4210916,-0.1541831,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0190685,0.0625965,-2.1048753,-0.1440216,0.0839055,-0.7303582,-0.2146441,-0.0000000,-0.0000000,0.0777773,0.1131626,0.0690621,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,-0.0000000,
])

angles = angles.reshape((-1,99))

for i in range(10):
  xyz = (fkl(angles[i],parent,offset, expmapInd, posIdn))
  #fig = plt.figure()
  #ax = Axes3D(fig)
  #x = xyz[:,0]
  #y = xyz[:,1]
  #z = xyz[:,2]
  #ax.plot(xs=x, ys=y, zs=z, zdir='z', label='ys=0, zdir=z')
  #plt.show()
  print(xyz)
